<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Reportar información – Vigilantia</title>

  <!-- Tailwind (mismo patrón de diseño) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50:'#f3f1ff',100:'#e9e4ff',200:'#cabdff',300:'#a892ff',
              400:'#8a6eff',500:'#6f4bff',600:'#5b3de6',700:'#4a32bf',
              800:'#3b2999',900:'#2f217a'
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-slate-50 text-slate-800">
  <main class="max-w-4xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-6">Reportar información de empleada doméstica</h1>

    <form id="reporteForm" class="space-y-6">
      <!-- Bloque fijo -->
      <section class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Nombres *</label>
          <input id="nombres" type="text" class="mt-1 w-full rounded-md border p-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium">Apellidos *</label>
          <input id="apellidos" type="text" class="mt-1 w-full rounded-md border p-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium">Número de cédula *</label>
          <input id="cedula" type="text" class="mt-1 w-full rounded-md border p-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium">Teléfono *</label>
          <input id="telefono" type="tel" class="mt-1 w-full rounded-md border p-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium">Email *</label>
          <input id="email" type="email" class="mt-1 w-full rounded-md border p-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium">Tipo de reporte *</label>
          <select id="tipoReporte" class="mt-1 w-full rounded-md border p-2" required>
            <option value="">Seleccione</option>
            <option value="INGRESO">INGRESO</option>
            <option value="SALIDA">SALIDA</option>
            <option value="INCIDENTE">INCIDENTE</option>
            <option value="NOVEDAD">NOVEDAD</option>
            <option value="PROCESO">PROCESO</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium">Foto de rostro *</label>
          <input id="fotoRostro" type="file" accept="image/*" class="mt-1 w-full rounded-md border p-2" required>
        </div>
        <div class="md:col-span-2 flex items-center gap-2">
          <input id="consentimiento" type="checkbox" class="rounded border" required>
          <label for="consentimiento" class="text-sm">
            Acepto los <a href="#" class="text-primary-600 underline">Términos &amp; Condiciones</a> y la
            <a href="#" class="text-primary-600 underline">Política de Tratamiento de Datos</a>.
          </label>
        </div>
      </section>

      <!-- INGRESO -->
      <section id="bloqueIngreso" class="hidden space-y-4 bg-white p-4 rounded-md shadow">
        <h2 class="font-semibold">Datos de ingreso</h2>
        <div>
          <label class="block text-sm font-medium">Modalidad *</label>
          <select id="ing_modalidad" class="mt-1 w-full rounded-md border p-2">
            <option value="">Seleccione</option>
            <option>Interna</option>
            <option>Por días</option>
            <option>Tiempo completo</option>
            <option>Parcial</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Días de la semana *</label>
          <div class="mt-1 grid grid-cols-2 sm:grid-cols-3 gap-2">
            <label class="flex items-center gap-2"><input type="checkbox" value="Lunes" class="diasSemana">Lun</label>
            <label class="flex items-center gap-2"><input type="checkbox" value="Martes" class="diasSemana">Mar</label>
            <label class="flex items-center gap-2"><input type="checkbox" value="Miércoles" class="diasSemana">Mié</label>
            <label class="flex items-center gap-2"><input type="checkbox" value="Jueves" class="diasSemana">Jue</label>
            <label class="flex items-center gap-2"><input type="checkbox" value="Viernes" class="diasSemana">Vie</label>
            <label class="flex items-center gap-2"><input type="checkbox" value="Sábado" class="diasSemana">Sáb</label>
          </div>
        </div>
        <div class="grid sm:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium">Salario *</label>
            <input id="ing_salario" type="number" class="mt-1 w-full rounded-md border p-2">
          </div>
          <div>
            <label class="block text-sm font-medium">Moneda *</label>
            <select id="ing_moneda" class="mt-1 w-full rounded-md border p-2">
              <option>COP</option><option>USD</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium">Periodicidad *</label>
            <select id="ing_periodicidad" class="mt-1 w-full rounded-md border p-2">
              <option>Mensual</option><option>Quincenal</option><option>Semanal</option>
            </select>
          </div>
        </div>
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">EPS *</label>
            <input id="ing_eps" type="text" class="mt-1 w-full rounded-md border p-2">
          </div>
          <div>
            <label class="block text-sm font-medium">ARL *</label>
            <input id="ing_arl" type="text" class="mt-1 w-full rounded-md border p-2">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium">Fecha de inicio *</label>
          <input id="ing_inicio" type="date" class="mt-1 w-full rounded-md border p-2">
        </div>
      </section>

      <!-- SALIDA -->
      <section id="bloqueSalida" class="hidden space-y-4 bg-white p-4 rounded-md shadow">
        <h2 class="font-semibold">Datos de salida</h2>
        <div>
          <label class="block text-sm font-medium">Fecha de salida *</label>
          <input id="sal_fecha" type="date" class="mt-1 w-full rounded-md border p-2">
        </div>
        <div>
          <label class="block text-sm font-medium">Motivo *</label>
          <select id="sal_motivo" class="mt-1 w-full rounded-md border p-2">
            <option value="">Seleccione</option>
            <option>Renuncia</option>
            <option>Mutuo acuerdo</option>
            <option>Justa causa</option>
            <option>Sin justa causa</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Recontratable *</label>
          <select id="sal_recontratable" class="mt-1 w-full rounded-md border p-2">
            <option value="">Seleccione</option>
            <option>Sí</option><option>No</option>
          </select>
        </div>
      </section>

      <!-- INCIDENTE -->
      <section id="bloqueIncidente" class="hidden space-y-4 bg-white p-4 rounded-md shadow">
        <h2 class="font-semibold">Detalles del incidente</h2>
        <div>
          <label class="block text-sm font-medium">Clasificación *</label>
          <select id="inc_clasificacion" class="mt-1 w-full rounded-md border p-2">
            <option value="">Seleccione</option>
            <option>Robo</option><option>Maltrato</option><option>Incumplimiento</option>
            <option>Negligencia</option><option>Otro</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Nivel de severidad *</label>
          <select id="inc_severidad" class="mt-1 w-full rounded-md border p-2">
            <option value="">Seleccione</option>
            <option>Bajo</option><option>Medio</option><option>Alto</option><option>Crítico</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Denuncia formal *</label>
          <select id="inc_denuncia" class="mt-1 w-full rounded-md border p-2">
            <option value="">Seleccione</option>
            <option>NO</option><option>SÍ</option>
          </select>
        </div>
        <div id="inc_detalle_denuncia" class="hidden grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Entidad</label>
            <input id="inc_entidad" type="text" class="mt-1 w-full rounded-md border p-2">
          </div>
          <div>
            <label class="block text-sm font-medium">Radicado</label>
            <input id="inc_radicado" type="text" class="mt-1 w-full rounded-md border p-2">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium">Descripción *</label>
          <textarea id="inc_descripcion" class="mt-1 w-full rounded-md border p-2" rows="4"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium">Evidencias (máx 10)</label>
          <input id="inc_evidencias" type="file" multiple class="mt-1 w-full rounded-md border p-2">
        </div>
      </section>

      <!-- NOVEDAD -->
      <section id="bloqueNovedad" class="hidden space-y-4 bg-white p-4 rounded-md shadow">
        <h2 class="font-semibold">Novedad</h2>
        <div>
          <label class="block text-sm font-medium">Tipo *</label>
          <select id="nov_tipo" class="mt-1 w-full rounded-md border p-2">
            <option value="">Seleccione</option>
            <option>Cambio de horario</option>
            <option>Llamado de atención</option>
            <option>Capacitación</option>
            <option>Otra</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Descripción *</label>
          <textarea id="nov_descripcion" rows="3" class="mt-1 w-full rounded-md border p-2"></textarea>
        </div>
      </section>

      <!-- PROCESO -->
      <section id="bloqueProceso" class="hidden space-y-4 bg-white p-4 rounded-md shadow">
        <h2 class="font-semibold">Proceso de selección</h2>
        <div>
          <label class="block text-sm font-medium">Tipo de proceso *</label>
          <select id="pro_tipo" class="mt-1 w-full rounded-md border p-2">
            <option value="">Seleccione</option>
            <option>Postulada</option>
            <option>Entrevista</option>
            <option>Prueba</option>
            <option>Oferta en firma</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Fuente *</label>
          <select id="pro_fuente" class="mt-1 w-full rounded-md border p-2">
            <option value="">Seleccione</option>
            <option>Hogar</option>
            <option>Agencia</option>
            <option>Plataforma</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Fecha próximo paso *</label>
          <input id="pro_fecha" type="date" class="mt-1 w-full rounded-md border p-2">
        </div>
      </section>

      <!-- Botones -->
      <div class="flex flex-wrap gap-4 pt-4">
        <button type="button" id="btnPreview"
          class="px-4 py-2 rounded-md bg-white border border-primary-500 text-primary-700 hover:bg-primary-50">
          Vista previa
        </button>
        <button type="submit"
          class="px-4 py-2 rounded-md bg-primary-600 text-white hover:bg-primary-700">
          Guardar / Enviar
        </button>
        <button type="reset"
          class="px-4 py-2 rounded-md bg-slate-200 text-slate-700 hover:bg-slate-300">
          Limpiar formulario
        </button>
      </div>
    </form>

    <!-- Preview -->
    <div id="previewContainer" class="hidden mt-6">
      <h2 class="text-lg font-semibold mb-2">Vista previa del JSON</h2>
      <pre id="previewJSON" class="bg-slate-800 text-slate-100 p-4 rounded-md overflow-auto"></pre>
    </div>
  </main>

  <script>
    const tipoReporte = document.getElementById('tipoReporte');
    const bloques = {
      INGRESO: document.getElementById('bloqueIngreso'),
      SALIDA: document.getElementById('bloqueSalida'),
      INCIDENTE: document.getElementById('bloqueIncidente'),
      NOVEDAD: document.getElementById('bloqueNovedad'),
      PROCESO: document.getElementById('bloqueProceso'),
    };

    tipoReporte.addEventListener('change', () => {
      Object.values(bloques).forEach(b => b.classList.add('hidden'));
      const val = tipoReporte.value;
      if (bloques[val]) bloques[val].classList.remove('hidden');
    });

    // Denuncia formal detalles
    const incDenuncia = document.getElementById('inc_denuncia');
    const incDetalleDenuncia = document.getElementById('inc_detalle_denuncia');
    incDenuncia.addEventListener('change', () => {
      incDetalleDenuncia.classList.toggle('hidden', incDenuncia.value !== 'SÍ');
    });

    // Helpers
    async function hashCedula(ced) {
      const data = new TextEncoder().encode(ced);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Vista previa
    document.getElementById('btnPreview').addEventListener('click', async () => {
      const data = await construirJSON(true);
      if (!data) return;
      document.getElementById('previewJSON').textContent =
        JSON.stringify(data, null, 2);
      document.getElementById('previewContainer').classList.remove('hidden');
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    });

    // Envío
    document.getElementById('reporteForm').addEventListener('submit', async e => {
      e.preventDefault();
      const data = await construirJSON();
      if (!data) return;
      alert('Reporte listo para enviar (ver consola)');
      console.log('Payload JSON:', data);
      // TODO: fetch('/api/reportes', {method:'POST', body:JSON.stringify(data)})
    });

    async function construirJSON(preview=false) {
      const tipo = tipoReporte.value;
      if (!tipo) { alert('Seleccione el tipo de reporte'); return null; }

      // Validaciones básicas
      const nombres = document.getElementById('nombres').value.trim();
      const apellidos = document.getElementById('apellidos').value.trim();
      const cedula = document.getElementById('cedula').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      const email = document.getElementById('email').value.trim();
      const fotoRostro = document.getElementById('fotoRostro').files[0];
      if (!nombres || !apellidos || !cedula || !telefono || !email || !fotoRostro) {
        alert('Complete todos los campos obligatorios'); return null;
      }

      const consentimiento = document.getElementById('consentimiento').checked;
      if (!consentimiento) { alert('Debe aceptar los términos y condiciones'); return null; }

      const base = {
        idReporte: crypto.randomUUID(),
        fechaHora: new Date().toISOString(),
        tipo,
        datosEmpleada: {
          nombres,
          apellidos,
          cedulaHash: await hashCedula(cedula),
          telefono,
          email,
          fotoRostro: await fileToBase64(fotoRostro)
        },
        detalles: {},
        evidencias: []
      };

      // Detalles por tipo
      if (tipo === 'INGRESO') {
        const modalidad = document.getElementById('ing_modalidad').value;
        const salario = document.getElementById('ing_salario').value;
        const moneda = document.getElementById('ing_moneda').value;
        const periodicidad = document.getElementById('ing_periodicidad').value;
        const eps = document.getElementById('ing_eps').value;
        const arl = document.getElementById('ing_arl').value;
        const inicio = document.getElementById('ing_inicio').value;
        const dias = Array.from(document.querySelectorAll('.diasSemana:checked')).map(d => d.value);
        if (!modalidad || !salario || !eps || !arl || !inicio || dias.length===0) {
          alert('Complete todos los campos de ingreso'); return null;
        }
        base.detalles = { modalidad, dias, salario, moneda, periodicidad, eps, arl, inicio };
      }

      if (tipo === 'SALIDA') {
        const fecha = document.getElementById('sal_fecha').value;
        const motivo = document.getElementById('sal_motivo').value;
        const recontratable = document.getElementById('sal_recontratable').value;
        if (!fecha || !motivo || !recontratable) {
          alert('Complete todos los campos de salida'); return null;
        }
        base.detalles = { fecha, motivo, recontratable };
      }

      if (tipo === 'INCIDENTE') {
        const clasificacion = document.getElementById('inc_clasificacion').value;
        const severidad = document.getElementById('inc_severidad').value;
        const denuncia = document.getElementById('inc_denuncia').value;
        const descripcion = document.getElementById('inc_descripcion').value.trim();
        const evidenciasInput = document.getElementById('inc_evidencias');
        if (!clasificacion || !severidad || !denuncia || !descripcion) {
          alert('Complete todos los campos del incidente'); return null;
        }
        const evidenciaFiles = Array.from(evidenciasInput.files).slice(0,10);
        const evidencias = [];
        for (const f of evidenciaFiles) {
          evidencias.push({ nombre: f.name, tipo: f.type, contenido: await fileToBase64(f) });
        }
        base.detalles = { clasificacion, severidad, denuncia,
          entidad: document.getElementById('inc_entidad').value.trim(),
          radicado: document.getElementById('inc_radicado').value.trim(),
          descripcion };
        base.evidencias = evidencias;
      }

      if (tipo === 'NOVEDAD') {
        const novTipo = document.getElementById('nov_tipo').value;
        const novDescripcion = document.getElementById('nov_descripcion').value.trim();
        if (!novTipo || !novDescripcion) {
          alert('Complete todos los campos de la novedad'); return null;
        }
        base.detalles = { tipo: novTipo, descripcion: novDescripcion };
      }

      if (tipo === 'PROCESO') {
        const proTipo = document.getElementById('pro_tipo').value;
        const proFuente = document.getElementById('pro_fuente').value;
        const proFecha = document.getElementById('pro_fecha').value;
        if (!proTipo || !proFuente || !proFecha) {
          alert('Complete todos los campos del proceso'); return null;
        }
        base.detalles = { tipoProceso: proTipo, fuente: proFuente, proximaFecha: proFecha };
      }

      return base;
    }
  </script>
</body>
</html>
